<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tahmin PazarÄ± Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #f3f4f6; --card: #ffffff; --primary: #3b82f6; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; text-align: center; }
        
        .container { max-width: 480px; margin: 0 auto; }
        
        h2 { font-size: 1.5rem; margin-bottom: 20px; color: #111; }

        /* Kart TasarÄ±mÄ± */
        .market-card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb; text-align: left; }
        .market-question { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; display: block; }
        
        /* Butonlar */
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; color: white; font-size: 0.95rem; }
        .btn:active { transform: scale(0.97); }
        .btn-yes { background: #10b981; } /* YeÅŸil */
        .btn-no { background: #ef4444; } /* KÄ±rmÄ±zÄ± */
        .btn-connect { background: #2563eb; width: 100%; padding: 15px; font-size: 1rem; margin-top: 20px; }

        /* Durum ve Hata AlanlarÄ± */
        .status-badge { font-size: 0.8rem; background: #e0f2fe; color: #0369a1; padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 20px; }
        .price-tag { font-size: 0.8rem; color: #6b7280; margin-top: 10px; text-align: center; }
        
        /* Debug Kutusu (Hata Yakalamak Ä°Ã§in) */
        #debug-log { 
            margin-top: 30px; padding: 10px; background: #000; color: #0f0; 
            font-family: monospace; font-size: 10px; text-align: left; 
            border-radius: 8px; max-height: 150px; overflow-y: auto; display: none;
        }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ† Tahmin PazarÄ±</h2>
        
        <div id="status-area" class="status-badge">BaÄŸlantÄ± bekleniyor...</div>

        <div id="markets-container">
            <button class="btn btn-connect" onclick="initWallet()">ğŸ¦Š CÃ¼zdanÄ± BaÄŸla ve YÃ¼kle</button>
        </div>

        <div id="debug-log"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- DÄ°KKAT: BURASI SENÄ°N KONTRAT ADRESÄ°N ---
        // EÄŸer Remix'te yeni deploy ettiysen bu adresi mutlaka gÃ¼ncelle!
        const contractAddress = "0x8929e710202167d60f4e38e6e58f0003080c98ec";
        
        const abi = [
            "function piyasalar(uint256) view returns (string, uint256, uint256, uint256, bool, bool)",
            "function marketCount() view returns (uint256)",
            "function bahisYap(uint256 _id, bool _vote) payable"
        ];

        let provider, signer, contract;

        function log(msg, isError = false) {
            const debugEl = document.getElementById('debug-log');
            debugEl.style.display = 'block';
            debugEl.innerHTML += `<div style="color:${isError ? 'red' : '#0f0'}">> ${msg}</div>`;
            console.log(msg);
        }

        async function initWallet() {
            log("BaÅŸlatÄ±lÄ±yor...");
            
            if (typeof window.ethereum === 'undefined') {
                alert("MetaMask bulunamadÄ±!");
                return;
            }

            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // 1. CÃ¼zdan Ä°zni Ä°ste
                log("CÃ¼zdan izni isteniyor...");
                await provider.send("eth_requestAccounts", []);
                
                // 2. AÄŸÄ± Kontrol Et ve Zorla DeÄŸiÅŸtir (Amoy: 80002 -> Hex: 0x13882)
                const network = await provider.getNetwork();
                log(`Mevcut AÄŸ ID: ${network.chainId}`);
                
                if (network.chainId !== 80002) {
                    log("YanlÄ±ÅŸ aÄŸ! Amoy aÄŸÄ±na geÃ§iÅŸ yapÄ±lÄ±yor...");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x13882' }], // 80002 in Hex
                        });
                        // AÄŸ deÄŸiÅŸince provider'Ä± yenile
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                    } catch (switchError) {
                        log("AÄŸ deÄŸiÅŸtirme reddedildi veya hata: " + switchError.message, true);
                        alert("LÃ¼tfen MetaMask'tan Polygon Amoy aÄŸÄ±nÄ± seÃ§in!");
                        return;
                    }
                }

                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                document.getElementById('status-area').innerText = `BaÄŸlÄ±: ${address.substring(0,6)}...${address.substring(38)}`;
                log("CÃ¼zdan baÄŸlandÄ±: " + address);

                // 3. KontratÄ± BaÅŸlat
                contract = new ethers.Contract(contractAddress, abi, signer);
                loadMarkets();

            } catch (error) {
                log("BAÄLANTI HATASI: " + error.message, true);
                alert("BaÄŸlantÄ± hatasÄ± oluÅŸtu. Loglara bakÄ±n.");
            }
        }

        async function loadMarkets() {
            const container = document.getElementById('markets-container');
            container.innerHTML = '<p class="loading">Veriler Blockchain\'den Ã§ekiliyor...</p>';
            
            try {
                // Kontrat var mÄ± kontrolÃ¼
                log("Piyasalar Ã§ekiliyor...");
                const count = await contract.marketCount();
                log(`Toplam Piyasa SayÄ±sÄ±: ${count}`);

                let html = "";
                let activeCount = 0;

                for (let i = 0; i < count; i++) {
                    const m = await contract.piyasalar(i);
                    // m[0]: Soru, m[4]: Bitti mi?
                    if (!m[4]) { 
                        activeCount++;
                        html += `
                            <div class="market-card">
                                <span class="market-question">${m[0]}</span>
                                <div class="btn-group">
                                    <button class="btn btn-yes" onclick="makeBet(${i}, true)">EVET</button>
                                    <button class="btn btn-no" onclick="makeBet(${i}, false)">HAYIR</button>
                                </div>
                                <div class="price-tag">Ä°ÅŸlem Ãœcreti: ~0.001 POL</div>
                            </div>
                        `;
                    }
                }

                if (activeCount === 0) {
                    container.innerHTML = "<p>Åu an aÃ§Ä±k piyasa yok. Bot ile oluÅŸturun.</p>";
                    log("AÃ§Ä±k piyasa bulunamadÄ±.");
                } else {
                    container.innerHTML = html;
                    log("Piyasalar baÅŸarÄ±yla yÃ¼klendi.");
                }

            } catch (error) {
                log("VERÄ° Ã‡EKME HATASI: " + error.message, true);
                container.innerHTML = `<p style="color:red">Hata oluÅŸtu!<br>Alttaki siyah kutuya bakÄ±n.</p>`;
            }
        }

        async function makeBet(id, vote) {
            try {
                log(`Bahis yapÄ±lÄ±yor ID: ${id} SeÃ§im: ${vote}`);
                
                // Bakiye ve Limit AyarÄ± (0.010 POL iÃ§in optimize)
                const tx = await contract.bahisYap(id, vote, { 
                    value: ethers.utils.parseEther("0.001"),
                    gasLimit: 150000 
                });
                
                tg.showAlert("Ä°ÅŸlem gÃ¶nderildi! LÃ¼tfen bekleyin...");
                log("Tx Hash: " + tx.hash);
                
                await tx.wait();
                tg.showAlert("BAÅARILI! Bahis onaylandÄ±.");
                loadMarkets(); // Listeyi yenile
                
            } catch (error) {
                log("BAHÄ°S HATASI: " + (error.data?.message || error.message), true);
                alert("Ä°ÅŸlem baÅŸarÄ±sÄ±z. Siyah log kutusuna bakÄ±n.");
            }
        }
        
        // Sayfa yÃ¼klenince otomatik baÄŸlamayÄ± dene (Ä°steÄŸe baÄŸlÄ±)
        // window.onload = initWallet; 
    </script>
</body>
</html>
